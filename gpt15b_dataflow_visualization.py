#!/usr/bin/env python3
"""
GPT-1.5Bæ¨ç†æ•°æ®æµå›¾å¯è§†åŒ–
å±•ç¤ºå®Œæ•´çš„æ¨ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å¤šGPUåˆ†ç‰‡å’Œé€šä¿¡
"""

import os
import sys
import time
import json
from pathlib import Path
from typing import Dict, Any, Optional, List, Tuple
from dataclasses import dataclass

# è®¾ç½®JAXç¯å¢ƒ
os.environ['XLA_PYTHON_CLIENT_PREALLOCATE'] = 'false'
os.environ['XLA_PYTHON_CLIENT_MEM_FRACTION'] = '0.8'
if 'XLA_FLAGS' in os.environ:
    del os.environ['XLA_FLAGS']

try:
    import jax
    import jax.numpy as jnp
    from jax import random, devices
    from jax.sharding import Mesh, PartitionSpec, NamedSharding
    from jax.experimental import mesh_utils
    import flax.linen as nn
    import numpy as np
    print(f"âœ… JAX {jax.__version__} æ•°æ®æµå¯è§†åŒ–æ¨¡å¼")
except ImportError as e:
    print(f"âŒ JAXå¯¼å…¥å¤±è´¥: {e}")
    sys.exit(1)

@dataclass
class GPT15BConfig:
    """GPT-1.5Bé…ç½®"""
    vocab_size: int = 50257
    n_positions: int = 2048
    n_embd: int = 1600
    n_layer: int = 48
    n_head: int = 25
    dropout: float = 0.0
    use_bias: bool = True

class GPTDataFlowVisualizer:
    """GPT-1.5Bæ•°æ®æµå¯è§†åŒ–å™¨"""
    
    def __init__(self):
        self.devices = jax.devices()
        self.config = GPT15BConfig()
        self.mesh = None
        
    def visualize_complete_dataflow(self):
        """å®Œæ•´çš„GPT-1.5Bæ•°æ®æµå¯è§†åŒ–"""
        print("ğŸ¨ GPT-1.5Bæ¨ç†æ•°æ®æµå›¾å¯è§†åŒ–")
        print("="*100)
        
        # æ­¥éª¤1ï¼šè¾“å…¥å¤„ç†
        self.step1_input_processing()
        
        # æ­¥éª¤2ï¼šåµŒå…¥å±‚
        self.step2_embedding_layer()
        
        # æ­¥éª¤3ï¼šTransformerå±‚åºåˆ—
        self.step3_transformer_layers()
        
        # æ­¥éª¤4ï¼šè¾“å‡ºå¤„ç†
        self.step4_output_processing()
        
        # æ­¥éª¤5ï¼šå¤šGPUåˆ†ç‰‡å¯è§†åŒ–
        self.step5_multi_gpu_sharding()
        
        # æ­¥éª¤6ï¼šå®é™…æ¨ç†æ¼”ç¤º
        self.step6_real_inference_demo()
    
    def step1_input_processing(self):
        """æ­¥éª¤1ï¼šè¾“å…¥å¤„ç†æ•°æ®æµ"""
        print("\nğŸ”¤ æ­¥éª¤1ï¼šè¾“å…¥å¤„ç†æ•°æ®æµ")
        print("="*80)
        
        print("ğŸ“ è¾“å…¥æ•°æ®æµå›¾ï¼š")
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è¾“å…¥å¤„ç†é˜¶æ®µ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  åŸå§‹æ–‡æœ¬                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ "Hello world!"  â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼ Tokenization                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ [15496, 995, 0] â”‚ â† Token IDs                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼ Padding & Batching                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ Input IDs: [B, seq_len]             â”‚                                    â”‚
â”‚  â”‚ Shape: (32, 512)                    â”‚ â† Batchå¤„ç†                        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”     â”‚                                    â”‚
â”‚  â”‚ â”‚15496â”‚ 995 â”‚  0  â”‚ ... â”‚ ... â”‚     â”‚                                    â”‚
â”‚  â”‚ â”‚15496â”‚ 995 â”‚  0  â”‚ ... â”‚ ... â”‚     â”‚                                    â”‚
â”‚  â”‚ â”‚ ... â”‚ ... â”‚ ... â”‚ ... â”‚ ... â”‚     â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜     â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â–¼ Attention Mask Generation                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ Attention Mask: [B, seq_len, seq_len] â”‚                                 â”‚
â”‚  â”‚ Shape: (32, 512, 512)               â”‚ â† å› æœæ©ç                          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚  â”‚ â”‚ 1 0 0 0 0 ... (ä¸‹ä¸‰è§’çŸ©é˜µ)     â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ 1 1 0 0 0 ...                   â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ 1 1 1 0 0 ...                   â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ 1 1 1 1 0 ...                   â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ ...                             â”‚ â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)
        
        print("ğŸ” æ•°æ®æµè¯¦è§£ï¼š")
        print("   1. æ–‡æœ¬æ ‡è®°åŒ–ï¼šå°†åŸå§‹æ–‡æœ¬è½¬æ¢ä¸ºtoken IDåºåˆ—")
        print("   2. æ‰¹æ¬¡æ‰“åŒ…ï¼šç»„åˆå¤šä¸ªåºåˆ—å½¢æˆæ‰¹æ¬¡")
        print("   3. å¡«å……å¯¹é½ï¼šç¡®ä¿åºåˆ—é•¿åº¦ä¸€è‡´")
        print("   4. æ©ç ç”Ÿæˆï¼šåˆ›å»ºå› æœæ³¨æ„åŠ›æ©ç ")
        
        print("\nğŸ“Š æ•°æ®å½¢çŠ¶å˜åŒ–ï¼š")
        print("   åŸå§‹æ–‡æœ¬ â†’ Tokenåºåˆ—: [seq_len]")
        print("   æ‰¹æ¬¡æ‰“åŒ… â†’ è¾“å…¥çŸ©é˜µ: [batch_size, seq_len]")
        print("   æ©ç çŸ©é˜µ â†’ æ³¨æ„åŠ›æ©ç : [batch_size, seq_len, seq_len]")
    
    def step2_embedding_layer(self):
        """æ­¥éª¤2ï¼šåµŒå…¥å±‚æ•°æ®æµ"""
        print("\nğŸ”¢ æ­¥éª¤2ï¼šåµŒå…¥å±‚æ•°æ®æµ")
        print("="*80)
        
        print("ğŸ“Š åµŒå…¥å±‚æ•°æ®æµå›¾ï¼š")
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           åµŒå…¥å±‚æ•°æ®æµ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¾“å…¥Token IDs                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ [32, 512] int32         â”‚ â† æ‰¹æ¬¡Ã—åºåˆ—é•¿åº¦                                â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”     â”‚                                                â”‚
â”‚  â”‚ â”‚15496â”‚ 995 â”‚  0  â”‚ ... â”‚                                                â”‚
â”‚  â”‚ â”‚15496â”‚ 995 â”‚  0  â”‚ ... â”‚                                                â”‚
â”‚  â”‚ â”‚ ... â”‚ ... â”‚ ... â”‚ ... â”‚                                                â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜     â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚                   â”‚   â”‚                 â”‚                               â”‚
â”‚  â”‚  Token Embedding  â”‚   â”‚ Position Embedding â”‚                           â”‚
â”‚  â”‚                   â”‚   â”‚                 â”‚                               â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                               â”‚
â”‚  â”‚ â”‚Vocab: 50257   â”‚ â”‚   â”‚ â”‚Pos: 2048    â”‚ â”‚                               â”‚
â”‚  â”‚ â”‚Dim:   1600    â”‚ â”‚   â”‚ â”‚Dim: 1600    â”‚ â”‚                               â”‚
â”‚  â”‚ â”‚               â”‚ â”‚   â”‚ â”‚             â”‚ â”‚                               â”‚
â”‚  â”‚ â”‚Weight Matrix  â”‚ â”‚   â”‚ â”‚Learned Pos  â”‚ â”‚                               â”‚
â”‚  â”‚ â”‚[50257, 1600]  â”‚ â”‚   â”‚ â”‚[2048, 1600] â”‚ â”‚                               â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚           â–¼                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚       Token Embeddings              â”‚                                    â”‚
â”‚  â”‚       [32, 512, 1600]               â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼ Element-wise Addition                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚     Combined Embeddings             â”‚                                    â”‚
â”‚  â”‚     [32, 512, 1600]                 â”‚ â† æœ€ç»ˆåµŒå…¥è¡¨ç¤º                     â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚  â”‚ â”‚æ¯ä¸ªtokençš„1600ç»´å‘é‡è¡¨ç¤º        â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚åŒ…å«è¯­ä¹‰ä¿¡æ¯å’Œä½ç½®ä¿¡æ¯           â”‚ â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)
        
        print("ğŸ” åµŒå…¥å±‚è¯¦è§£ï¼š")
        print("   1. TokenåµŒå…¥ï¼šå°†token IDæ˜ å°„åˆ°é«˜ç»´å‘é‡ç©ºé—´")
        print("   2. ä½ç½®åµŒå…¥ï¼šä¸ºæ¯ä¸ªä½ç½®å­¦ä¹ å¯è®­ç»ƒçš„ä½ç½®å‘é‡")
        print("   3. å‘é‡ç›¸åŠ ï¼šé€å…ƒç´ ç›¸åŠ è·å¾—æœ€ç»ˆçš„è¾“å…¥è¡¨ç¤º")
        
        print("\nğŸ“Š å‚æ•°ç»Ÿè®¡ï¼š")
        token_emb_params = self.config.vocab_size * self.config.n_embd
        pos_emb_params = self.config.n_positions * self.config.n_embd
        total_emb_params = token_emb_params + pos_emb_params
        
        print(f"   TokenåµŒå…¥å‚æ•°: {token_emb_params:,} ({token_emb_params/1e6:.1f}M)")
        print(f"   ä½ç½®åµŒå…¥å‚æ•°: {pos_emb_params:,} ({pos_emb_params/1e6:.1f}M)")
        print(f"   åµŒå…¥å±‚æ€»å‚æ•°: {total_emb_params:,} ({total_emb_params/1e6:.1f}M)")
    
    def step3_transformer_layers(self):
        """æ­¥éª¤3ï¼šTransformerå±‚æ•°æ®æµ"""
        print("\nğŸ§  æ­¥éª¤3ï¼šTransformerå±‚æ•°æ®æµ")
        print("="*80)
        
        print("ğŸ“Š å•ä¸ªTransformerå—æ•°æ®æµï¼š")
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Transformer Block æ•°æ®æµ (1/48)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¾“å…¥: [32, 512, 1600]                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ X = Combined Embeddings             â”‚                                    â”‚
â”‚  â”‚     [Batch, Seq, Hidden]            â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Residual Connection           â”‚
â”‚                     â”‚                     â”‚                               â”‚
â”‚                     â–¼                     â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                               â”‚
â”‚  â”‚         Layer Norm 1                â”‚  â”‚                               â”‚
â”‚  â”‚         [32, 512, 1600]             â”‚  â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                               â”‚
â”‚                     â”‚                     â”‚                               â”‚
â”‚                     â–¼                     â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Multi-Head Attention                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚  â”‚     Q     â”‚  â”‚     K     â”‚  â”‚     V     â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚[32,512,   â”‚  â”‚[32,512,   â”‚  â”‚[32,512,   â”‚                       â”‚   â”‚
â”‚  â”‚  â”‚   1600]   â”‚  â”‚   1600]   â”‚  â”‚   1600]   â”‚ â† LinearæŠ•å½±            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â”‚         â”‚             â”‚             â”‚                               â”‚   â”‚
â”‚  â”‚         â–¼             â–¼             â–¼                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚    Reshape to Multi-Head Format     â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚    [32, 25, 512, 64]               â”‚ â† 25ä¸ªæ³¨æ„åŠ›å¤´              â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                     â”‚                                               â”‚   â”‚
â”‚  â”‚                     â–¼                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚         Scaled Dot-Product           â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚         Attention                   â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚   Attention = softmax(QK^T/âˆšd_k)V   â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                     â”‚                                               â”‚   â”‚
â”‚  â”‚                     â–¼                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚      Concatenate Heads              â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚      [32, 512, 1600]               â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                     â”‚                                               â”‚   â”‚
â”‚  â”‚                     â–¼                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚       Output Projection             â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚       [32, 512, 1600]               â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                                     â”‚
â”‚                     â–¼                                                     â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚   ADD   â”‚ â† æ®‹å·®è¿æ¥
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                     â”‚
â”‚                     â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚          Layer Norm 2               â”‚
â”‚  â”‚          [32, 512, 1600]            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                     â”‚
â”‚                     â–¼
â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Residual Connection
â”‚                     â”‚                     â”‚
â”‚                     â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Feed Forward Network                             â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚        Linear Layer 1               â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚        [32, 512, 6400]             â”‚ â† 4xéšè—ç»´åº¦æ‰©å±•            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                     â”‚                                               â”‚   â”‚
â”‚  â”‚                     â–¼                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚         GELU Activation             â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚         [32, 512, 6400]            â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â”‚                     â”‚                                               â”‚   â”‚
â”‚  â”‚                     â–¼                                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚        Linear Layer 2               â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚        [32, 512, 1600]             â”‚ â† æ¢å¤åˆ°éšè—ç»´åº¦            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                                     â”‚
â”‚                     â–¼                                                     â”‚
â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                â”‚   ADD   â”‚ â† æ®‹å·®è¿æ¥
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                     â”‚
â”‚                     â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚    è¾“å‡ºåˆ°ä¸‹ä¸€å±‚: [32, 512, 1600]     â”‚ â† ä¼ é€’ç»™ä¸‹ä¸€ä¸ªTransformerå—
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)
        
        print("\nğŸ”„ 48å±‚Transformeråºåˆ—ï¼š")
        print("""
Layer 1  â†’ Layer 2  â†’ Layer 3  â†’ ... â†’ Layer 48
  â†“          â†“          â†“                 â†“
[B,S,H]   [B,S,H]   [B,S,H]   ...    [B,S,H]

å…¶ä¸­: B=32(batch), S=512(sequence), H=1600(hidden)
        """)
        
        print("\nğŸ“Š å•å±‚å‚æ•°ç»Ÿè®¡ï¼š")
        # æ³¨æ„åŠ›å±‚å‚æ•°
        qkv_params = 3 * self.config.n_embd * self.config.n_embd
        attn_out_params = self.config.n_embd * self.config.n_embd
        attn_total = qkv_params + attn_out_params
        
        # MLPå±‚å‚æ•°
        mlp_up_params = self.config.n_embd * 4 * self.config.n_embd
        mlp_down_params = 4 * self.config.n_embd * self.config.n_embd
        mlp_total = mlp_up_params + mlp_down_params
        
        # LayerNormå‚æ•°
        ln_params = 2 * 2 * self.config.n_embd  # 2ä¸ªLayerNormï¼Œæ¯ä¸ªæœ‰scaleå’Œbias
        
        layer_total = attn_total + mlp_total + ln_params
        
        print(f"   æ³¨æ„åŠ›å±‚å‚æ•°: {attn_total:,} ({attn_total/1e6:.1f}M)")
        print(f"   MLPå±‚å‚æ•°: {mlp_total:,} ({mlp_total/1e6:.1f}M)")
        print(f"   LayerNormå‚æ•°: {ln_params:,} ({ln_params/1e3:.1f}K)")
        print(f"   å•å±‚æ€»å‚æ•°: {layer_total:,} ({layer_total/1e6:.1f}M)")
        print(f"   48å±‚æ€»å‚æ•°: {layer_total * 48:,} ({layer_total * 48/1e6:.1f}M)")
    
    def step4_output_processing(self):
        """æ­¥éª¤4ï¼šè¾“å‡ºå¤„ç†æ•°æ®æµ"""
        print("\nğŸ“¤ æ­¥éª¤4ï¼šè¾“å‡ºå¤„ç†æ•°æ®æµ")
        print("="*80)
        
        print("ğŸ“Š è¾“å‡ºå±‚æ•°æ®æµå›¾ï¼š")
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è¾“å‡ºå¤„ç†é˜¶æ®µ                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ¥è‡ªæœ€åä¸€å±‚Transformer                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚   Hidden States                     â”‚                                    â”‚
â”‚  â”‚   [32, 512, 1600]                   â”‚ â† æœ€ç»ˆçš„éšè—è¡¨ç¤º                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚      Final Layer Norm               â”‚                                    â”‚
â”‚  â”‚      [32, 512, 1600]                â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   Language Model Head                               â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚   â”‚
â”‚  â”‚  â”‚      Linear Projection              â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚      [32, 512, 50257]              â”‚ â† æŠ•å½±åˆ°è¯æ±‡è¡¨å¤§å°          â”‚   â”‚
â”‚  â”‚  â”‚                                     â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â”‚    Weight Matrix              â”‚  â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â”‚    [1600, 50257]              â”‚  â”‚ â† ä¸token embeddingå…±äº«    â”‚   â”‚
â”‚  â”‚  â”‚  â”‚                               â”‚  â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ æ¯ä¸ªéšè—ç»´åº¦å¯¹åº”              â”‚  â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ æ•´ä¸ªè¯æ±‡è¡¨çš„æ¦‚ç‡åˆ†å¸ƒ          â”‚  â”‚                           â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚         Logits                      â”‚                                    â”‚
â”‚  â”‚         [32, 512, 50257]            â”‚ â† åŸå§‹åˆ†æ•°                          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚  â”‚ â”‚æ¯ä¸ªä½ç½®å¯¹æ‰€æœ‰vocabçš„æœªå½’ä¸€åŒ–åˆ†æ•°â”‚ â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚       Softmax (å¯é€‰)                â”‚                                    â”‚
â”‚  â”‚       [32, 512, 50257]              â”‚                                    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚  â”‚ â”‚   æ¦‚ç‡åˆ†å¸ƒ (sum=1 for each pos) â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚   P(token|context)              â”‚ â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚    Token Sampling/Selection         â”‚                                    â”‚
â”‚  â”‚                                     â”‚                                    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                    â”‚
â”‚  â”‚ â”‚ â€¢ Greedy: argmax(logits)        â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ â€¢ Top-k: é€‰æ‹©top-kå€™é€‰           â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ â€¢ Top-p: æ ¸é‡‡æ ·                 â”‚ â”‚                                    â”‚
â”‚  â”‚ â”‚ â€¢ Temperature: æ§åˆ¶éšæœºæ€§       â”‚ â”‚                                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚                                                       â”‚
â”‚                     â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚      Next Token IDs                 â”‚                                    â”‚
â”‚  â”‚      [32, 1]                        â”‚ â† æ¯ä¸ªåºåˆ—çš„ä¸‹ä¸€ä¸ªtoken            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)
        
        print("ğŸ” è¾“å‡ºå¤„ç†è¯¦è§£ï¼š")
        print("   1. æœ€ç»ˆLayerNormï¼šæ ‡å‡†åŒ–æœ€åçš„éšè—çŠ¶æ€")
        print("   2. è¯­è¨€æ¨¡å‹å¤´ï¼šå°†éšè—çŠ¶æ€æŠ•å½±åˆ°è¯æ±‡è¡¨ç©ºé—´")
        print("   3. Logitsç”Ÿæˆï¼šä¸ºæ¯ä¸ªtokenè®¡ç®—æœªå½’ä¸€åŒ–åˆ†æ•°")
        print("   4. Tokené‡‡æ ·ï¼šæ ¹æ®ç­–ç•¥é€‰æ‹©ä¸‹ä¸€ä¸ªtoken")
        
        print("\nğŸ“Š è¾“å‡ºå±‚å‚æ•°ç»Ÿè®¡ï¼š")
        lm_head_params = self.config.n_embd * self.config.vocab_size
        print(f"   LM Headå‚æ•°: {lm_head_params:,} ({lm_head_params/1e6:.1f}M)")
        print("   æ³¨æ„ï¼šé€šå¸¸ä¸token embeddingæƒé‡å…±äº«")
    
    def step5_multi_gpu_sharding(self):
        """æ­¥éª¤5ï¼šå¤šGPUåˆ†ç‰‡æ•°æ®æµ"""
        print("\nğŸ”€ æ­¥éª¤5ï¼šå¤šGPUåˆ†ç‰‡æ•°æ®æµ")
        print("="*80)
        
        if len(self.devices) < 4:
            print("âš ï¸ éœ€è¦4ä¸ªGPUæ¥å±•ç¤ºå®Œæ•´çš„åˆ†ç‰‡ç­–ç•¥")
            return
        
        print("ğŸ“Š 4GPUåˆ†ç‰‡ç­–ç•¥æ•°æ®æµï¼š")
        print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        4GPU 2x2 åˆ†ç‰‡ç­–ç•¥                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è®¾å¤‡ç½‘æ ¼å¸ƒå±€ï¼š                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚    GPU 0    â”‚    GPU 1    â”‚ â† dataè½´=0                                  â”‚
â”‚  â”‚   (0,0)     â”‚   (0,1)     â”‚                                             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                              â”‚
â”‚  â”‚    GPU 2    â”‚    GPU 3    â”‚ â† dataè½´=1                                  â”‚
â”‚  â”‚   (1,0)     â”‚   (1,1)     â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚       â†‘             â†‘                                                       â”‚
â”‚    model=0       model=1                                                    â”‚
â”‚                                                                             â”‚
â”‚  è¾“å…¥æ•°æ®åˆ†ç‰‡ï¼š[32, 512] â†’ æŒ‰batchç»´åº¦åˆ†ç‰‡                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ GPU 0: [16, 512] â”‚ GPU 1: [16, 512] â”‚ â† å‰16ä¸ªæ ·æœ¬ | å16ä¸ªæ ·æœ¬           â”‚
â”‚  â”‚ GPU 2: [16, 512] â”‚ GPU 3: [16, 512] â”‚                                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â”‚  åµŒå…¥æƒé‡åˆ†ç‰‡ï¼š[50257, 1600] â†’ æŒ‰vocabç»´åº¦åˆ†ç‰‡                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ GPU 0: [25128,1600] â”‚ GPU 1: [25129,1600] â”‚ â† vocabå‰åŠ | vocabååŠ     â”‚
â”‚  â”‚ GPU 2: [25128,1600] â”‚ GPU 3: [25129,1600] â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â”‚  æ³¨æ„åŠ›æƒé‡åˆ†ç‰‡ï¼šQKVæŠ•å½± [1600, 4800] â†’ æŒ‰headç»´åº¦åˆ†ç‰‡                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ GPU 0: [1600,2400] â”‚ GPU 1: [1600,2400] â”‚ â† å‰12.5å¤´ | å12.5å¤´         â”‚
â”‚  â”‚ GPU 2: [1600,2400] â”‚ GPU 3: [1600,2400] â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â”‚  MLPæƒé‡åˆ†ç‰‡ï¼š[1600, 6400] â†’ æŒ‰éšè—ç»´åº¦åˆ†ç‰‡                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚  â”‚ GPU 0: [1600,3200] â”‚ GPU 1: [1600,3200] â”‚ â† å‰åŠéšè—å±‚ | ååŠéšè—å±‚      â”‚
â”‚  â”‚ GPU 2: [1600,3200] â”‚ GPU 3: [1600,3200] â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                             â”‚
â”‚  é€šä¿¡æ¨¡å¼ï¼š                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. All-Gather: æ”¶é›†attentionå¤´ç»“æœ                                 â”‚   â”‚
â”‚  â”‚    GPU0,1,2,3 â†’ äº¤æ¢å¤´è®¡ç®—ç»“æœ                                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ 2. All-Reduce: MLPå±‚ç»“æœèšåˆ                                       â”‚   â”‚
â”‚  â”‚    GPU0,1,2,3 â†’ æ±‚å’Œéšè—å±‚è®¡ç®—                                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚ 3. Reduce-Scatter: è¾“å‡ºlogitsåˆ†å¸ƒ                                  â”‚   â”‚
â”‚  â”‚    GPU0,1,2,3 â†’ é‡æ–°åˆ†ç‰‡ç»“æœ                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        """)
        
        print("ğŸ” åˆ†ç‰‡ç­–ç•¥è¯¦è§£ï¼š")
        print("   1. æ•°æ®å¹¶è¡Œï¼šbatchç»´åº¦åˆ†ç‰‡ï¼Œæ¯GPUå¤„ç†éƒ¨åˆ†æ ·æœ¬")
        print("   2. æ¨¡å‹å¹¶è¡Œï¼šå‚æ•°æŒ‰ä¸åŒç»´åº¦åˆ†ç‰‡åˆ°ä¸åŒGPU")
        print("   3. æ··åˆå¹¶è¡Œï¼šç»“åˆæ•°æ®å’Œæ¨¡å‹å¹¶è¡Œç­–ç•¥")
        print("   4. è‡ªåŠ¨é€šä¿¡ï¼šJAXè‡ªåŠ¨æ’å…¥å¿…è¦çš„é€šä¿¡æ“ä½œ")
        
        # åˆ›å»ºå®é™…çš„meshæ¼”ç¤º
        self._create_actual_mesh_demo()
    
    def _create_actual_mesh_demo(self):
        """åˆ›å»ºå®é™…çš„meshæ¼”ç¤º"""
        devices_array = np.array(self.devices[:4]).reshape(2, 2)
        self.mesh = Mesh(devices_array, axis_names=('data', 'model'))
        
        print("\nğŸ•¸ï¸ å®é™…è®¾å¤‡ç½‘æ ¼ï¼š")
        print(f"   ç½‘æ ¼å½¢çŠ¶: {dict(self.mesh.shape)}")
        print(f"   è½´åç§°: {self.mesh.axis_names}")
        print(f"   è®¾å¤‡åˆ†å¸ƒ:")
        
        for i in range(2):
            for j in range(2):
                device = self.mesh.devices[i, j]
                print(f"     ä½ç½®[{i},{j}]: {device}")
    
    def step6_real_inference_demo(self):
        """æ­¥éª¤6ï¼šå®é™…æ¨ç†æ¼”ç¤º"""
        print("\nğŸš€ æ­¥éª¤6ï¼šå®é™…æ¨ç†æ¼”ç¤º")
        print("="*80)
        
        if not self.mesh:
            print("âš ï¸ éœ€è¦åˆ›å»ºmeshæ‰èƒ½è¿›è¡Œå®é™…æ¼”ç¤º")
            return
        
        print("ğŸ¬ æ‰§è¡Œå®é™…çš„åˆ†ç‰‡æ¨ç†...")
        
        # æ¨¡æ‹ŸGPTæ¨ç†çš„å…³é”®è®¡ç®—
        def simple_gpt_step(x, wte, wpe, attn_w, mlp_w):
            """ç®€åŒ–çš„GPTå‰å‘æ­¥éª¤"""
            # 1. åµŒå…¥
            batch_size, seq_len = x.shape
            token_emb = wte[x]  # [batch, seq, embd]
            pos_ids = jnp.arange(seq_len)[None, :]  # [1, seq]
            pos_emb = wpe[pos_ids]  # [1, seq, embd]
            hidden = token_emb + pos_emb
            
            # 2. ç®€åŒ–çš„æ³¨æ„åŠ›
            hidden = jnp.dot(hidden, attn_w)
            hidden = jax.nn.gelu(hidden)
            
            # 3. ç®€åŒ–çš„MLP
            hidden = jnp.dot(hidden, mlp_w)
            
            # 4. è¾“å‡ºlogits
            logits = jnp.dot(hidden, wte.T)  # æƒé‡å…±äº«
            
            return logits
        
        # JITç¼–è¯‘
        jit_gpt_step = jax.jit(simple_gpt_step)
        
        with self.mesh:
            # åˆ›å»ºæµ‹è¯•æ•°æ®
            key = jax.random.PRNGKey(42)
            batch_size, seq_len = 8, 64
            vocab_size, hidden_dim = 1000, 512  # ç®€åŒ–å°ºå¯¸
            
            # è¾“å…¥æ•°æ®
            input_ids = jax.random.randint(key, (batch_size, seq_len), 0, vocab_size)
            
            # æ¨¡å‹æƒé‡ï¼ˆç®€åŒ–ï¼‰
            wte = jax.random.normal(key, (vocab_size, hidden_dim)) * 0.02
            wpe = jax.random.normal(key, (seq_len, hidden_dim)) * 0.02
            attn_w = jax.random.normal(key, (hidden_dim, hidden_dim)) * 0.02
            mlp_w = jax.random.normal(key, (hidden_dim, hidden_dim)) * 0.02
            
            # å®šä¹‰åˆ†ç‰‡ç­–ç•¥
            input_sharding = NamedSharding(self.mesh, PartitionSpec('data', None))
            wte_sharding = NamedSharding(self.mesh, PartitionSpec('model', None))
            wpe_sharding = NamedSharding(self.mesh, PartitionSpec(None, None))
            attn_sharding = NamedSharding(self.mesh, PartitionSpec(None, 'model'))
            mlp_sharding = NamedSharding(self.mesh, PartitionSpec('model', None))
            
            # åº”ç”¨åˆ†ç‰‡
            input_ids_sharded = jax.device_put(input_ids, input_sharding)
            wte_sharded = jax.device_put(wte, wte_sharding)
            wpe_sharded = jax.device_put(wpe, wpe_sharding)
            attn_w_sharded = jax.device_put(attn_w, attn_sharding)
            mlp_w_sharded = jax.device_put(mlp_w, mlp_sharding)
            
            print("ğŸ“Š åˆ†ç‰‡ä¿¡æ¯ï¼š")
            print(f"   è¾“å…¥: {input_ids.shape} â†’ PartitionSpec('data', None)")
            print(f"   TokenåµŒå…¥: {wte.shape} â†’ PartitionSpec('model', None)")
            print(f"   ä½ç½®åµŒå…¥: {wpe.shape} â†’ PartitionSpec(None, None)")
            print(f"   æ³¨æ„åŠ›æƒé‡: {attn_w.shape} â†’ PartitionSpec(None, 'model')")
            print(f"   MLPæƒé‡: {mlp_w.shape} â†’ PartitionSpec('model', None)")
            
            # é¢„çƒ­
            print("\nğŸ”¥ JITç¼–è¯‘é¢„çƒ­...")
            for i in range(3):
                logits = jit_gpt_step(
                    input_ids_sharded, wte_sharded, wpe_sharded, 
                    attn_w_sharded, mlp_w_sharded
                )
                jax.block_until_ready(logits)
                print(f"   é¢„çƒ­ {i+1}/3 å®Œæˆ")
            
            # æ€§èƒ½æµ‹è¯•
            print("\nâš¡ æ¨ç†æ€§èƒ½æµ‹è¯•...")
            times = []
            for i in range(5):
                start_time = time.time()
                logits = jit_gpt_step(
                    input_ids_sharded, wte_sharded, wpe_sharded,
                    attn_w_sharded, mlp_w_sharded
                )
                jax.block_until_ready(logits)
                end_time = time.time()
                
                elapsed = end_time - start_time
                times.append(elapsed)
                print(f"   æµ‹è¯• {i+1}: {elapsed*1000:.2f}ms")
            
            avg_time = np.mean(times)
            tokens_processed = batch_size * seq_len
            throughput = tokens_processed / avg_time
            
            print(f"\nğŸ¯ æ¨ç†ç»“æœï¼š")
            print(f"   è¾“å…¥å½¢çŠ¶: {input_ids.shape}")
            print(f"   è¾“å‡ºå½¢çŠ¶: {logits.shape}")
            print(f"   å¹³å‡æ—¶é—´: {avg_time*1000:.2f}ms")
            print(f"   å¤„ç†tokenæ•°: {tokens_processed}")
            print(f"   ååé‡: {throughput:.1f} tokens/s")
            print(f"   è®¾å¤‡åˆ©ç”¨: {len(self.devices)}ä¸ªGPUå¹¶è¡Œ")
            
            # ä¿å­˜ç»“æœ
            results = {
                'input_shape': list(input_ids.shape),
                'output_shape': list(logits.shape),
                'avg_time_ms': avg_time * 1000,
                'throughput_tokens_per_sec': throughput,
                'devices_used': len(self.devices),
                'mesh_shape': dict(self.mesh.shape)
            }
            
            results_file = Path("gpt15b_dataflow_demo_results.json")
            with open(results_file, 'w') as f:
                json.dump(results, f, indent=2)
            
            print(f"\nğŸ’¾ ç»“æœå·²ä¿å­˜: {results_file}")
    
    def generate_summary(self):
        """ç”Ÿæˆæ•°æ®æµæ€»ç»“"""
        print("\nğŸ¯ GPT-1.5Bæ•°æ®æµæ€»ç»“")
        print("="*80)
        
        print("ğŸ“Š å®Œæ•´æ•°æ®æµè·¯å¾„ï¼š")
        print("""
æ–‡æœ¬è¾“å…¥ â†’ Tokenization â†’ 
    â†“
Token IDs [B, S] â†’ Token Embedding [B, S, H] â†’ 
    â†“
Position Embedding [S, H] â†’ Combined Embedding [B, S, H] â†’
    â†“
Transformer Layer 1 â†’ ... â†’ Transformer Layer 48 â†’
    â†“
Final LayerNorm [B, S, H] â†’ LM Head [B, S, V] â†’
    â†“
Logits [B, S, V] â†’ Token Sampling â†’ Next Token IDs [B, 1]

å…¶ä¸­: B=Batch, S=Sequence, H=Hidden(1600), V=Vocab(50257)
        """)
        
        print("\nğŸš€ åˆ†å¸ƒå¼åŠ é€Ÿç­–ç•¥ï¼š")
        print("   âœ… æ•°æ®å¹¶è¡Œï¼šbatchç»´åº¦åˆ†ç‰‡åˆ°å¤šGPU")
        print("   âœ… æ¨¡å‹å¹¶è¡Œï¼šå‚æ•°çŸ©é˜µåˆ†ç‰‡åˆ°å¤šGPU") 
        print("   âœ… æ³¨æ„åŠ›å¤´å¹¶è¡Œï¼šå¤šå¤´æ³¨æ„åŠ›åˆ†å¸ƒè®¡ç®—")
        print("   âœ… è‡ªåŠ¨é€šä¿¡ï¼šJAXå¤„ç†GPUé—´æ•°æ®äº¤æ¢")
        
        print("\nğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼š")
        print("   âœ… JITç¼–è¯‘ï¼šé™æ€å›¾ç¼–è¯‘ä¼˜åŒ–")
        print("   âœ… æ“ä½œèåˆï¼šå‡å°‘å†…å­˜è®¿é—®")
        print("   âœ… æ··åˆç²¾åº¦ï¼šå¯é€‰FP16åŠ é€Ÿ")
        print("   âœ… æƒé‡å…±äº«ï¼šembeddingå’ŒLM headå…±äº«æƒé‡")
        
        # è®¡ç®—æ€»å‚æ•°é‡
        total_params = self._calculate_total_params()
        print(f"\nğŸ“Š æ¨¡å‹è§„æ¨¡ç»Ÿè®¡ï¼š")
        print(f"   æ€»å‚æ•°é‡: {total_params:,} ({total_params/1e9:.2f}B)")
        print(f"   æ¨¡å‹å¤§å°: {total_params * 4 / (1024**3):.2f}GB (FP32)")
        print(f"   æ¨èGPUå†…å­˜: â‰¥ {total_params * 4 / (1024**3) * 1.5:.1f}GB")
    
    def _calculate_total_params(self):
        """è®¡ç®—æ€»å‚æ•°é‡"""
        # åµŒå…¥å±‚
        token_emb = self.config.vocab_size * self.config.n_embd
        pos_emb = self.config.n_positions * self.config.n_embd
        
        # Transformerå±‚
        qkv_params = 3 * self.config.n_embd * self.config.n_embd
        attn_out_params = self.config.n_embd * self.config.n_embd
        mlp_up_params = self.config.n_embd * 4 * self.config.n_embd
        mlp_down_params = 4 * self.config.n_embd * self.config.n_embd
        ln_params = 2 * 2 * self.config.n_embd  # 2ä¸ªLayerNormï¼Œæ¯ä¸ªæœ‰scaleå’Œbias
        
        layer_params = qkv_params + attn_out_params + mlp_up_params + mlp_down_params + ln_params
        
        # è¾“å‡ºå±‚ï¼ˆé€šå¸¸ä¸token embeddingå…±äº«ï¼Œè¿™é‡Œä¸é‡å¤è®¡ç®—ï¼‰
        final_ln_params = 2 * self.config.n_embd
        
        total = token_emb + pos_emb + layer_params * self.config.n_layer + final_ln_params
        return total

def main():
    """ä¸»å‡½æ•°"""
    visualizer = GPTDataFlowVisualizer()
    
    print("ğŸ¨ å¼€å§‹GPT-1.5Bæ¨ç†æ•°æ®æµå¯è§†åŒ–...")
    
    # æ‰§è¡Œå®Œæ•´çš„æ•°æ®æµå¯è§†åŒ–
    visualizer.visualize_complete_dataflow()
    
    # ç”Ÿæˆæ€»ç»“
    visualizer.generate_summary()
    
    print("\nğŸ‰ GPT-1.5Bæ•°æ®æµå¯è§†åŒ–å®Œæˆï¼")
    print("   ç°åœ¨æ‚¨å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ•´ä¸ªæ¨ç†è¿‡ç¨‹çš„æ•°æ®æµå‘ã€‚")

if __name__ == "__main__":
    main()
